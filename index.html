<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>野灣保育探索館排班表</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background: #f0f4f3; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        h1 { color: #388e3c; text-align: center; margin: 0 0 10px 0; font-size: 1.8em; letter-spacing: 1px; }
        .sub-info { text-align: center; color: #888; font-size: 0.85em; margin-bottom: 25px; }
        
        /* 狀態區塊 */
        #status-box { text-align: center; padding: 40px; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #388e3c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; display: inline-block; text-align: left; white-space: pre-wrap; font-size: 0.9em; }
        .retry-btn { margin-top: 10px; background: #388e3c; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; }

        /* 月曆網格 */
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-head { background: #e8f5e9; color: #2e7d32; padding: 10px 0; text-align: center; font-weight: bold; border-radius: 6px; font-size: 0.95em; }
        
        .cell { 
            background: #fff; border: 1px solid #e0e0e0; min-height: 85px; padding: 8px; border-radius: 8px; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .date-num { font-weight: bold; color: #546e7a; font-size: 1.1em; margin-bottom: 4px; }
        
        /* 人員標籤 */
        .tag { 
            text-align: center; padding: 4px 0; border-radius: 6px; 
            font-size: 0.9em; font-weight: bold; margin-top: auto; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .tag-enya { background: #dcedc8; color: #33691e; border: 1px solid #c5e1a5; } 
        .tag-hong { background: #ffecb3; color: #ff6f00; border: 1px solid #ffe082; } 
        .tag-niu { background: #b3e5fc; color: #01579b; border: 1px solid #81d4fa; }  
        
        /* 公休 */
        .off-day { background-color: #fafafa; background-image: repeating-linear-gradient(45deg, #f5f5f5, #f5f5f5 5px, #eeeeee 5px, #eeeeee 10px); }
        .tag-off { background: #e0e0e0; color: #757575; font-size: 0.8em; width: 60%; margin: auto; padding: 2px 0; border-radius: 10px; }

        @media (max-width: 600px) {
            .grid { display: flex; flex-direction: column; gap: 0; }
            .day-head { display: none; }
            .cell { flex-direction: row; align-items: center; min-height: auto; margin-bottom: 8px; padding: 12px; border-bottom: 2px solid #eee; }
            .date-num { width: 50px; margin-bottom: 0; }
            .tag { width: auto; min-width: 90px; margin-top: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="title">排班表載入中...</h1>
    <div class="sub-info">最後更新：<span id="updateTime">...</span></div>

    <div id="status-box">
        <div class="loading-spinner"></div>
        <div>正在下載最新排班資料...</div>
    </div>

    <div id="calendar" class="grid" style="display:none;"></div>
</div>

<script>
    // 使用您剛剛提供的「已發佈」連結 (2PACX 開頭)
    const publishedCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGMCRoaKLdiCnXS4EPJQ8xsLc7I3wCEnNv-eMwmCFNJdzrE5rKfC4364YZh7Kj55z0cc67xlkQkz_G/pub?gid=565009246&single=true&output=csv';
    
    // 使用 CORS Proxy 加速並加上時間戳記 (解決緩存問題)
    const targetUrl = publishedCsvUrl + '&t=' + new Date().getTime();
    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

    const STAFF = {
        '雅': { name: '林恩雅', cls: 'tag-enya' },
        '瑛': { name: '黃虹瑛', cls: 'tag-hong' },
        '牛': { name: '牛韻茹', cls: 'tag-niu' },
        'x': { name: '-', cls: '' }
    };

    function init() {
        fetch(proxyUrl)
            .then(response => {
                if (!response.ok) throw new Error(`連線錯誤 (${response.status}) - 請確認網址是否正確`);
                return response.text();
            })
            .then(csvText => {
                Papa.parse(csvText, {
                    header: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            renderNewFormat(results.data);
                            document.getElementById('status-box').style.display = 'none';
                            
                            // 手機/電腦版顯示切換修正
                            const cal = document.getElementById('calendar');
                            cal.style.display = window.innerWidth <= 600 ? 'flex' : 'grid';
                            cal.style.flexDirection = window.innerWidth <= 600 ? 'column' : '';

                            document.getElementById('updateTime').innerText = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
                        } catch (e) {
                            showError("資料解析失敗：" + e.message + "\n(請確認 Excel A 欄是否有正確填寫：年、月、日、班表)");
                        }
                    }
                });
            })
            .catch(err => {
                showError("無法讀取資料，請檢查網路連線。\n\n詳細錯誤：" + err.message);
            });
    }

    function renderNewFormat(data) {
        // 1. 倒敘搜尋：找到最後一列A欄為「班表」的資料
        let scheduleRowIndex = -1;
        for (let i = data.length - 1; i >= 0; i--) {
            // 用 trim() 去除可能的空白
            if (data[i][0] && data[i][0].toString().trim() === '班表') {
                scheduleRowIndex = i;
                break;
            }
        }

        if (scheduleRowIndex === -1) throw new Error("在表格中找不到A欄為「班表」的資料列");

        // 2. 依照新格式，往上推算 年、月、日
        // Row - 3 : 年 | 2026
        // Row - 2 : 月 | 1
        // Row - 1 : 日 | 1 | 2 | 3 ...
        // Row - 0 : 班表 | 瑛 | 瑛 ...
        
        // 檢查陣列邊界，避免報錯
        if (scheduleRowIndex < 3) throw new Error("「班表」列上方資料不足，無法讀取年/月/日");

        const scheduleRow = data[scheduleRowIndex];
        const dateRow = data[scheduleRowIndex - 1]; 
        const monthRow = data[scheduleRowIndex - 2];
        const yearRow = data[scheduleRowIndex - 3];

        // 簡單驗證標題列 (寬鬆檢查，只要包含關鍵字即可)
        // B欄位的值 (index 1)
        const year = parseInt(yearRow[1]);
        const month = parseInt(monthRow[1]);

        if (isNaN(year) || isNaN(month)) throw new Error(`讀取到的年份(${yearRow[1]})或月份(${monthRow[1]})格式不正確`);

        // 更新標題
        document.getElementById('title').innerText = `野灣保育探索館：${year} 年 ${month} 月排班`;

        // 4. 繪製月曆
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';

        // 星期頭
        ['日', '一', '二', '三', '四', '五', '六'].forEach(d => {
            const head = document.createElement('div');
            head.className = 'day-head';
            head.innerText = d;
            cal.appendChild(head);
        });

        const daysInMonth = new Date(year, month, 0).getDate();
        const firstDayWeek = new Date(year, month - 1, 1).getDay();

        // 填補前面空白 (僅電腦版)
        if (window.innerWidth > 600) {
            for(let i=0; i<firstDayWeek; i++) cal.innerHTML += `<div style="background:transparent;"></div>`;
        }

        // 產生每一天
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month - 1, d);
            const weekDay = dateObj.getDay();

            // 找 CSV 對應的欄位 (日期數字在哪一格)
            let dataIdx = -1;
            // 從 index 1 (B欄) 開始找，防止 A 欄干擾
            for(let k=1; k < dateRow.length; k++) {
                if(parseInt(dateRow[k]) === d) {
                    dataIdx = k;
                    break;
                }
            }

            let cellClass = 'cell';
            let content = '';

            if (weekDay === 3) { // 週三公休
                cellClass += ' off-day';
                content = `<div class="tag tag-off">公休</div>`;
            } else if (dataIdx !== -1 && scheduleRow[dataIdx]) {
                const code = scheduleRow[dataIdx].trim();
                const staff = STAFF[code];
                
                if (staff) {
                    content = `<div class="tag ${staff.cls}">${staff.name}</div>`;
                } else if (code !== 'x' && code !== '') {
                    content = `<div class="tag" style="background:#eee">${code}</div>`;
                }
            }

            const wStr = ['日','一','二','三','四','五','六'][weekDay];
            const dateHtml = window.innerWidth <= 600 ? `${d} <small style="color:#aaa; font-weight:normal;">(${wStr})</small>` : d;

            cal.innerHTML += `
                <div class="${cellClass}">
                    <div class="date-num">${dateHtml}</div>
                    ${content}
                </div>
            `;
        }
    }

    function showError(msg) {
        const box = document.getElementById('status-box');
        box.innerHTML = `
            <div class="error-msg">⚠️ ${msg}</div>
            <br>
            <button class="retry-btn" onclick="location.reload()">重新整理</button>
        `;
    }

    init();
</script>

</body>
</html>
